#include "predict_gaze.h"

extern unsigned short val[112*112];
unsigned short pred[2];

float bh[6] = { -0.0020438935027245449041478, 0.0018766231376706609020044, -0.0060928668020389141826709, -0.0073584772047099377897950, 0.0022250247273848809854979, 0.0058007173424610251888378 };

float bo[2] = { 0.3883272602360938186016881, 0.4479592300591487274985525 };

unsigned short mask[27][2] = {
	{ 26, 64 },
	{ 26, 68 },
	{ 27, 61 },
	{ 31, 61 },
	{ 32, 68 },
	{ 40, 75 },
	{ 41, 75 },
	{ 41, 78 },
	{ 42, 79 },
	{ 43, 43 },
	{ 44, 41 },
	{ 44, 42 },
	{ 44, 74 },
	{ 45, 42 },
	{ 45, 43 },
	{ 46, 43 },
	{ 47, 69 },
	{ 48, 42 },
	{ 48, 43 },
	{ 48, 68 },
	{ 48, 73 },
	{ 49, 73 },
	{ 50, 72 },
	{ 50, 73 },
	{ 51, 45 },
	{ 51, 73 },
	{ 52, 73 },
};

float who[6][2] = {
	{ -2.0202327022451189719731701, -0.2297967250608125011623883 },
	{ -0.5090316901274044569802868, 1.4870012945065460563398574 },
	{ -0.6291598496159199749300228, -0.4975852977100947982513901 },
	{ 0.5914755781982982130173809, 0.1192306600972059954512972 },
	{ -0.3475733284547827817156929, 0.3172357290229109172408073 },
	{ -0.4744666691214791121034011, -0.3445861950834381848274290 },
};

float wih[27][6] = {
	{ -0.0000183168480470097612314, 0.0000711115179406227271254, -0.0000268334054064799406691, 0.0000000000000000000000000, 0.0000142428787240591406282, -0.0000187370365237224284255 },
	{ -0.0068754562452841344252774, 0.0176267322923646004018128, -0.0075475422371615559849478, 0.0027200925566411059478011, 0.0032616240049051278132586, -0.0053087281136399546224713 },
	{ -0.0001289033170435574049764, 0.0005440400010342605428143, -0.0002007463633107176026200, 0.0000584415026858589673744, 0.0001103835566088444002141, -0.0001399753582663273044229 },
	{ -0.0034349363638549630650676, 0.0138046893347943001179035, -0.0051630447248249486391636, 0.0015391186329467439718177, 0.0027774857652524730447507, -0.0036033582070648679379632 },
	{ -0.0010384812697869559659086, 0.0014350864978287369150278, -0.0007979895551737455506452, 0.0003668301705811811887908, 0.0002102931788189925052003, -0.0005682576644557531860696 },
	{ -0.0253939050947964185811490, -0.0080936282493117277930805, -0.0075437231476949365843732, 0.0074744842276735631511619, -0.0048197334455958402640863, -0.0057250613328666171211734 },
	{ -0.0206971418906981494134634, -0.0092249636488941182121959, -0.0054246604004133591389603, 0.0060049582561243989436983, -0.0045367615884327854025582, -0.0041724616037142068028509 },
	{ -0.0196236644787539903089790, -0.0079289917847831653530122, -0.0053758860434254557986167, 0.0057291568147796977095165, -0.0041192317569488916956244, -0.0041155170088583957477280 },
	{ -0.0114547843719647705895692, -0.0052821787287789957049400, -0.0029645802739101429108814, 0.0033290928748845368539966, -0.0025603337163609459631308, -0.0022846187289205571388506 },
	{ 0.0092822021443688777775360, 0.0000196457062221986704365, 0.0035286028171087470244049, -0.0027917472756257429543358, 0.0010553711839195051031687, 0.0026151585484664187884751 },
	{ 0.0000517073264086463933774, 0.0000000000000000000000000, 0.0000199093182426245394231, -0.0000155594915191504789003, 0.0000000000000000000000000, 0.0000147379952442872698198 },
	{ 0.0097366560515946033727008, -0.0007608186475843686357584, 0.0039195720564529209703486, -0.0029567856322075900671331, 0.0009274109799460970729804, 0.0028922538446972431529225 },
	{ -0.0219028313236500904448434, -0.0175623719154373095219235, -0.0036128740451226381245886, 0.0061164881751460328795922, -0.0066205123835488101716185, -0.0029660773666608220532070 },
	{ 0.0272717183721603410873069, -0.0028350073348824638384824, 0.0111750424220429904476060, -0.0083073617582918764246092, 0.0024357464333519939642114, 0.0082353666375982424729951 },
	{ 0.0202376968362823414504525, -0.0030225229947143188689862, 0.0085434364231998429634052, -0.0061930180683241551481411, 0.0015935933005072739319929, 0.0062820595779448382481314 },
	{ 0.0211660713404789313507592, -0.0037300122020453600410472, 0.0090955837981094647681779, -0.0064992643976253599777393, 0.0015370260157807969555316, 0.0066798739729157056987940 },
	{ -0.0008936891765599780379503, -0.0009313954992327654882830, -0.0000877744480028449082596, 0.0002420511566235543940515, -0.0003196540610111091957821, -0.0000803032041748191890637 },
	{ 0.0257732496567732692616115, -0.0062807279629900668663223, 0.0115417218961017496725585, -0.0079584904210318451606154, 0.0014596025045951750535866, 0.0084506889287442737979106 },
	{ 0.0254177563251689088430485, -0.0061062555972158328795873, 0.0113571813982839293216687, -0.0078450128607356062193645, 0.0014595491129139809890342, 0.0083167767200697205465243 },
	{ -0.0020872221721858459989041, -0.0021532019903097898878841, -0.0002101377067899807876607, 0.0005651120257445814811306, -0.0007408130141413777356232, -0.0001909642102145670905598 },
	{ -0.0141738826349952704020119, -0.0095455614884246264145728, -0.0028425882803062561300644, 0.0040215030432812328212155, -0.0038649407611893349563659, -0.0022638744551803230420362 },
	{ -0.0092635000665949717574277, -0.0060689749004719907923833, -0.0019030152756116260580332, 0.0026323336806768080423091, -0.0024855058480697861042485, -0.0015102797039705160003081 },
	{ -0.0083304723846704849254952, -0.0058988577419555442843402, -0.0015895533588509141043749, 0.0023522503153907180564741, -0.0023370033775226570563199, -0.0012750650802934729646787 },
	{ -0.0034897352287650341452763, -0.0024435977234057337965922, -0.0006725557497711646699062, 0.0009854767334162820198451, -0.0009721261338422961017017, -0.0005386210720015689647905 },
	{ 0.0029531931110142969378052, -0.0010848336185145040447969, 0.0014225376090521240322884, -0.0009235507326217867827417, 0.0000824526188775541734070, 0.0010365098015119979593668 },
	{ -0.0066502105108504861938346, -0.0046875596137902712096102, -0.0012810146260259129905035, 0.0018842657726967769905163, -0.0018642933923937129482573, -0.0010266813896847369440291 },
	{ -0.0159866017910686684933008, -0.0135293502444988802263515, -0.0024485344537010381507636, 0.0044470223265156462455483, -0.0050001293496520467576905, -0.0020369979726839048013443 },
};


float tanh_values[] = {
-0.999909204263 ,
-0.999889102951 ,
-0.999864551701 ,
-0.999834565554 ,
-0.999797941612 ,
-0.999753210848 ,
-0.999698579284 ,
-0.99963185619 ,
-0.99955036646 ,
-0.999450843688 ,
-0.999329299739 ,
-0.99918086567 ,
-0.998999597786 ,
-0.998778241281 ,
-0.998507942332 ,
-0.998177897611 ,
-0.997774927934 ,
-0.997282960099 ,
-0.99668239784 ,
-0.995949359222 ,
-0.995054753687 ,
-0.993963167351 ,
-0.992631520201 ,
-0.991007453678 ,
-0.989027402201 ,
-0.986614298151 ,
-0.983674857694 ,
-0.980096396266 ,
-0.975743130031 ,
-0.970451936613 ,
-0.964027580076 ,
-0.956237458128 ,
-0.946806012846 ,
-0.935409070603 ,
-0.921668554406 ,
-0.905148253645 ,
-0.885351648202 ,
-0.861723159313 ,
-0.833654607012 ,
-0.800499021761 ,
-0.761594155956 ,
-0.716297870199 ,
-0.664036770268 ,
-0.604367777117 ,
-0.537049566998 ,
-0.46211715726 ,
-0.379948962255 ,
-0.291312612452 ,
-0.197375320225 ,
-0.099667994625 ,
0.0 ,
0.099667994625 ,
0.197375320225 ,
0.291312612452 ,
0.379948962255 ,
0.46211715726 ,
0.537049566998 ,
0.604367777117 ,
0.664036770268 ,
0.716297870199 ,
0.761594155956 ,
0.800499021761 ,
0.833654607012 ,
0.861723159313 ,
0.885351648202 ,
0.905148253645 ,
0.921668554406 ,
0.935409070603 ,
0.946806012846 ,
0.956237458128 ,
0.964027580076 ,
0.970451936613 ,
0.975743130031 ,
0.980096396266 ,
0.983674857694 ,
0.986614298151 ,
0.989027402201 ,
0.991007453678 ,
0.992631520201 ,
0.993963167351 ,
0.995054753687 ,
0.995949359222 ,
0.99668239784 ,
0.997282960099 ,
0.997774927934 ,
0.998177897611 ,
0.998507942332 ,
0.998778241281 ,
0.998999597786 ,
0.99918086567 ,
0.999329299739 ,
0.999450843688 ,
0.99955036646 ,
0.99963185619 ,
0.999698579284 ,
0.999753210848 ,
0.999797941612 ,
0.999834565554 ,
0.999864551701 ,
0.999889102951 ,
0.999909204263 ,
};

void predict_gaze()
{
    int i, j;
    float ah[6];
    float x, x_val, y_val;

    for (i = 0; i < NUM_HIDDEN; i++)  {
        ah[i] = bh[i] / 255;
    }

    for (i = 0; i < NUM_SUBSAMPLE; i++) {
        // val = global containing subsampled pixel data
        x = (float)(val[i]) / 255;

        for (j = 0; j < NUM_HIDDEN; j++) {
            ah[j] += x * wih[i][j];
        }
    }

    x_val = bo[0];
    y_val = bo[1];

    for (i = 0; i < NUM_HIDDEN; i++) {
        x_val += who[i][0] * tanh_approx(ah[i]);
        y_val += who[i][1] * tanh_approx(ah[i]);
    }

    // pred = global for storing prediction values
    pred[0] = (unsigned short)((x_val * 112) + 0.5);
    pred[1] = (unsigned short)((y_val * 112) + 0.5);
}

float tanh_approx(float input)
{
    if (input <= -5)
        return -1;
    else if (input >= 5)
        return 1;

    // Offset input value
    input += 5;

    // Each index corresponds to 0.1 in the range from -5 to 5 (0 to 10 after offset)
    int lower_index = (int)(input * 10);
    int upper_index = lower_index + 1;

    // Just in case precision or rounding issues push us into the clipped range
    if (lower_index < 0)
        return -1;
    if (lower_index >= 99)
        return 1;

    float x0 = (float)(lower_index) / 10, x1 = (float)(upper_index) / 10;
    float y0 = tanh_values[lower_index], y1 = tanh_values[upper_index];

    float approx = y0 + (y1 - y0) * ((input - x0) / (x1 - x0));

    return approx;
}
